<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Transporte Escolar</title>
  <link rel="stylesheet" href="../assets/css/styles.css"/>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Transporte Escolar</div>
          <div class="subtitle">Panel de DigitaciÃ³n</div>
        </div>
      </div>
      <div class="toolbar" aria-label="Controles">
        <button class="btn" data-action="speak" title="Narrador">ğŸ—£ï¸</button>
        <button class="btn" data-action="theme" title="Tema">ğŸŒ“</button>
        <button class="btn" data-action="fontPlus" title="Aumentar">A+</button>
        <button class="btn" data-action="fontMinus" title="Disminuir">Aâˆ’</button>
        <button class="btn" data-action="lang" title="Idioma">ğŸŒ</button>
        <a class="btn ghost" href="../index.html" title="Inicio">ğŸ </a>
      </div>
    </div>
    <div class="container">
      <div class="pillnav">
        <a href="../index.html">ğŸ  <span data-i18n="home">home</span></a>
<a href="../app/login.html">ğŸ” <span data-i18n="login">login</span></a>
<a href="../app/dashboard.html">ğŸ§¾ <span data-i18n="panel">panel</span></a>
<a href="../tools/importer.html">ğŸ§° <span data-i18n="importer">importer</span></a>
<a href="../dashboards/buses.html">ğŸšŒ <span data-i18n="buses">buses</span></a>
<a href="../dashboards/cursos.html">ğŸ“ <span data-i18n="cursos">cursos</span></a>
      </div>
    </div>
  </div>

  <main class="container">
    
<div class="grid">
  <section class="card" style="grid-column: span 12;">
    <div class="hd">
      <div>
        <h2>ğŸ§¾ Panel de DigitaciÃ³n</h2>
        <p>Busca por RUT, revisa datos del estudiante y asigna bus/recorrido. Control de cupos y lista de espera automÃ¡tica.</p>
      </div>
      <div class="row">
        <span class="badge" id="modeBadge">Modo: â€”</span>
        <button class="btn" id="btnLogout">Salir</button>
      </div>
    </div>
    <div class="bd">
      <div class="row">
        <div class="field">
          <label>Buscar por RUT</label>
          <input id="rut" placeholder="12345678-9" />
        </div>
        <div class="field" style="min-width:140px;">
          <label>&nbsp;</label>
          <button class="btn primary" id="btnBuscar">ğŸ” Buscar</button>
        </div>
        <div class="field">
          <label>Bus</label>
          <select id="busSelect"></select>
        </div>
        <div class="field">
          <label>Recorrido</label>
          <input id="recorrido" placeholder="Se completa desde el bus" />
        </div>
        <div class="field" style="min-width:160px;">
          <label>&nbsp;</label>
          <button class="btn primary" id="btnAsignar">âœ… Asignar</button>
        </div>
        <div class="field" style="min-width:160px;">
          <label>&nbsp;</label>
          <button class="btn" id="btnAuto">ğŸ¤– Autoasignar</button>
        </div>
      </div>

      <div class="hr"></div>
      <div id="studentCard" class="notice small">Sin estudiante seleccionado.</div>

      <div class="hr"></div>
      <div class="row">
        <button class="btn" id="btnExport">ğŸ“¤ Exportar Excel (todo)</button>
        <button class="btn" id="btnRefresh">ğŸ”„ Refrescar (Sync)</button>
        <a class="btn" href="../dashboards/buses.html">ğŸšŒ Dashboard Buses</a>
        <a class="btn" href="../dashboards/cursos.html">ğŸ“ Dashboard Cursos</a>
      </div>
    </div>
  </section>

  <section class="card" style="grid-column: span 6;">
    <div class="hd"><div><h2>ğŸšŒ Buses</h2><p>Define buses, recorrido y capacidad. La capacidad controla la lista de espera.</p></div>
    <button class="btn" id="btnAddBus">â• Nuevo</button>
    </div>
    <div class="bd">
      <div id="busList"></div>
    </div>
  </section>

  <section class="card" style="grid-column: span 6;">
    <div class="hd"><div><h2>ğŸ—ºï¸ Zonas</h2><p>Patrones (keywords) para sugerir zona desde domicilio/comuna.</p></div>
    <button class="btn" id="btnAddZona">â• Nueva</button>
    </div>
    <div class="bd">
      <div id="zonaList"></div>
    </div>
  </section>

  <section class="card" style="grid-column: span 12;">
    <div class="hd"><div><h2>âš™ï¸ ConfiguraciÃ³n</h2><p>Modo Local vs Sync (Multiâ€‘PC). En Sync se usa Google Sheets + Apps Script.</p></div></div>
    <div class="bd">
      <div class="row">
        <button class="btn" id="btnModeLocal">ğŸ’½ Modo Local</button>
        <button class="btn" id="btnModeSync">â˜ï¸ Modo Sync</button>
        <span class="small">En Sync: define URL + API Key en <span class="kbd">config/config.js</span> (o en Ajustes avanzados abajo).</span>
      </div>
      <div class="hr"></div>
      <div class="row">
        <div class="field">
          <label>Apps Script URL (Web App)</label>
          <input id="asUrl" placeholder="https://script.google.com/macros/s/....../exec"/>
        </div>
        <div class="field">
          <label>API Key</label>
          <input id="apiKey" placeholder="Clave fuerte"/>
        </div>
        <div class="field" style="min-width:160px;">
          <label>&nbsp;</label>
          <button class="btn" id="btnSaveSync">ğŸ’¾ Guardar</button>
        </div>
        <div class="field" style="min-width:160px;">
          <label>&nbsp;</label>
          <button class="btn primary" id="btnPing">ğŸ“¡ Probar conexiÃ³n</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="notice small" id="syncNote">Sync deshabilitado.</div>
    </div>
  </section>

  <section class="card" style="grid-column: span 12;">
    <div class="hd"><div><h2>â³ En espera (Rezagados)</h2><p>Se agregan automÃ¡ticamente cuando el bus estÃ¡ lleno.</p></div></div>
    <div class="bd" style="overflow:auto;">
      <table class="table" id="waitTable">
        <thead><tr>
          <th>RUT</th><th>Bus</th><th>Recorrido</th><th>Motivo</th><th>Digitador</th><th>Fecha</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<script>
function esc(s){return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
function fmtDate(ts){ try{ return new Date(ts).toLocaleString('es-CL'); }catch(e){ return ''; } }

let session=null, cache=null;

function busCard(b){
  const cap = parseInt(b.capacidad||'0',10);
  return `
  <div class="notice" style="margin-bottom:10px;">
    <div class="row" style="justify-content:space-between;">
      <div>
        <strong>ğŸšŒ ${esc(b.nombre||'Bus')}</strong>
        <div class="small">ID: <span class="kbd">${esc(b.bus_id||'')}</span> â€¢ Capacidad: <span class="kbd">${cap||'â€”'}</span></div>
        <div class="small">Recorrido: ${esc(b.recorrido||'')}</div>
        <div class="small">Zonas: ${esc(b.zonas||'')}</div>
      </div>
      <button class="btn danger" data-del-bus="${esc(b.bus_id)}">Eliminar</button>
    </div>
  </div>`;
}
function zonaCard(z){
  return `
  <div class="notice" style="margin-bottom:10px;">
    <div class="row" style="justify-content:space-between;">
      <div>
        <strong>ğŸ—ºï¸ ${esc(z.nombre||'Zona')}</strong>
        <div class="small">Patrones: ${esc(z.patrones||'')}</div>
      </div>
      <button class="btn danger" data-del-zona="${esc(z.zona_id)}">Eliminar</button>
    </div>
  </div>`;
}

async function loadCache(){
  const mode = await TS.core.getMode();
  document.getElementById('modeBadge').textContent = 'Modo: ' + (mode==='sync' ? 'â˜ï¸ Sync' : 'ğŸ’½ Local');
  if(mode==='sync'){
    try{
      cache = await TS.core.refreshFromSync();
    }catch(e){
      TS.toast('â›” Sync: ' + e.message);
      cache = await TS.core.loadAllLocal();
    }
  }else{
    cache = await TS.core.loadAllLocal();
  }
  return cache;
}

function renderWaitlist(){
  const tb = document.querySelector('#waitTable tbody');
  const w = cache.waitlist || [];
  tb.innerHTML = w.slice(0,200).map(x=>`
    <tr>
      <td><span class="kbd">${esc(x.rut)}</span></td>
      <td>${esc(x.bus_nombre||'')}</td>
      <td>${esc(x.recorrido||'')}</td>
      <td><span class="badge warn">â³ ${esc(x.motivo||'')}</span></td>
      <td>${esc(x.digitador||'')}</td>
      <td>${esc(fmtDate(x.ts))}</td>
    </tr>`).join('');
}

function renderBuses(){
  const list = document.getElementById('busList');
  const buses = cache.buses || [];
  list.innerHTML = buses.map(busCard).join('') || '<div class="small">AÃºn no hay buses. Crea al menos 1.</div>';
  // delete handlers
  list.querySelectorAll('[data-del-bus]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-del-bus');
      const buses2 = (cache.buses||[]).filter(b=>b.bus_id!==id);
      cache.buses = buses2;
      await TS.core.upsertBusesLocal(buses2);
      TS.toast('ğŸ—‘ï¸ Bus eliminado (local). Si estÃ¡s en Sync, luego sube cambios.');
      await rebuildBusSelect();
      renderBuses();
    });
  });
}
function renderZonas(){
  const list = document.getElementById('zonaList');
  const zonas = cache.zonas || [];
  list.innerHTML = zonas.map(zonaCard).join('') || '<div class="small">AÃºn no hay zonas. Crea al menos 1 para sugerencias.</div>';
  list.querySelectorAll('[data-del-zona]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-del-zona');
      const zonas2 = (cache.zonas||[]).filter(z=>z.zona_id!==id);
      cache.zonas = zonas2;
      await TS.core.upsertZonasLocal(zonas2);
      TS.toast('ğŸ—‘ï¸ Zona eliminada (local).');
      renderZonas();
    });
  });
}

async function rebuildBusSelect(){
  const sel = document.getElementById('busSelect');
  sel.innerHTML = '';
  (cache.buses||[]).forEach(b=>{
    const o = document.createElement('option');
    o.value=b.bus_id;
    o.textContent = `${b.nombre} (${b.capacidad||'âˆ'})`;
    sel.appendChild(o);
  });
  sel.addEventListener('change', ()=>{
    const b = (cache.buses||[]).find(x=>x.bus_id===sel.value);
    document.getElementById('recorrido').value = b ? (b.recorrido||'') : '';
  });
  if(sel.value){
    const b = (cache.buses||[]).find(x=>x.bus_id===sel.value);
    document.getElementById('recorrido').value = b ? (b.recorrido||'') : '';
  }
}

function renderStudent(student){
  const nom = [student.nombres, student.apellido_paterno, student.apellido_materno].filter(Boolean).join(' ');
  const z = TS.core.suggestZona(student, cache.zonas||[]);
  const zTxt = z ? (z.nombre||'') : '(sin zona sugerida)';
  document.getElementById('studentCard').innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <div>
        <div><strong>ğŸ‘¤ ${esc(nom||'')}</strong> <span class="badge">${esc(student.rut)}</span></div>
        <div class="small">ğŸ“§ ${esc(student.email||'')}</div>
        <div class="small">ğŸ  ${esc(student.domicilio||'')} â€¢ ${esc(student.comuna||'')}</div>
        <div class="small">ğŸ“ Nivel 2026: <span class="kbd">${esc(student.nivel2026||'')}</span> â€¢ Curso 2025: <span class="kbd">${esc(student.curso2025||'')}</span></div>
        <div class="small">ğŸ—ºï¸ Zona sugerida: <span class="kbd">${esc(zTxt)}</span></div>
      </div>
      <div>
        <button class="btn" id="btnCopyMail">Copiar correo</button>
      </div>
    </div>
  `;
  document.getElementById('btnCopyMail').addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(student.email||''); TS.toast('ğŸ“‹ Copiado'); }catch(e){ TS.toast('â›” No se pudo copiar'); }
  });
}

function findStudentByRut(rut){
  const r = String(rut||'').replace(/\./g,'').trim();
  return (cache.students||[]).find(s=>String(s.rut).replace(/\./g,'').trim()===r);
}

async function assign(student, bus){
  const mode = await TS.core.getMode();
  const payload = {student, bus, digitador: session.email};
  if(mode==='sync'){
    const res = await TS.core.assignSync(payload);
    TS.toast(res.status==='WAITLIST' ? 'â³ Bus lleno: enviado a espera' : 'âœ… Asignado');
    await loadCache();
  }else{
    const res = await TS.core.assignLocal(payload);
    TS.toast(res.status==='WAITLIST' ? 'â³ Bus lleno: enviado a espera' : 'âœ… Asignado');
    cache = await TS.core.loadAllLocal();
  }
  renderWaitlist();
}

document.addEventListener('DOMContentLoaded', async ()=>{
  session = TS.auth.requireAuth();
  document.getElementById('btnLogout').addEventListener('click', ()=>{
    TS.auth.logout();
    location.href='login.html';
  });

  await loadCache();
  await rebuildBusSelect();
  renderBuses();
  renderZonas();
  renderWaitlist();

  document.getElementById('btnBuscar').addEventListener('click', ()=>{
    const rut = document.getElementById('rut').value;
    const st = findStudentByRut(rut);
    if(!st){ TS.toast('â›” RUT no encontrado en base'); return; }
    window.__currentStudent = st;
    renderStudent(st);
  });

  document.getElementById('btnAsignar').addEventListener('click', async ()=>{
    const st = window.__currentStudent;
    if(!st){ TS.toast('â›” Primero busca un RUT'); return; }
    const busId = document.getElementById('busSelect').value;
    const bus = (cache.buses||[]).find(b=>b.bus_id===busId);
    if(!bus){ TS.toast('â›” Debes crear/seleccionar un bus'); return; }
    // override recorrido if edited
    bus.recorrido = document.getElementById('recorrido').value || bus.recorrido || '';
    await assign(st, bus);
  });

  document.getElementById('btnAuto').addEventListener('click', async ()=>{
    const st = window.__currentStudent;
    if(!st){ TS.toast('â›” Primero busca un RUT'); return; }
    const bus = TS.core.suggestBus(st, cache.zonas||[], cache.buses||[], cache.assignments||[]);
    if(!bus){ TS.toast('â›” Sin sugerencia: define zonas y buses'); return; }
    document.getElementById('busSelect').value = bus.bus_id;
    document.getElementById('recorrido').value = bus.recorrido || '';
    await assign(st, bus);
  });

  document.getElementById('btnExport').addEventListener('click', async ()=>{
    const mode = await TS.core.getMode();
    if(mode==='sync'){
      await loadCache(); // ensures local cache updated from sync
    }
    const data = await TS.core.loadAllLocal();
    const wb = TS.excel.buildExportWorkbook(data);
    TS.excel.downloadWorkbook(wb, 'TransporteEscolar_Asignaciones.xlsx');
    TS.toast('ğŸ“¤ Exportado');
  });

  document.getElementById('btnRefresh').addEventListener('click', async ()=>{
    try{
      await loadCache();
      await rebuildBusSelect();
      renderBuses(); renderZonas(); renderWaitlist();
      TS.toast('ğŸ”„ OK');
    }catch(e){ TS.toast('â›” ' + e.message); }
  });

  document.getElementById('btnAddBus').addEventListener('click', async ()=>{
    const nombre = prompt('Nombre del bus (ej: Bus 1)');
    if(!nombre) return;
    const recorrido = prompt('Recorrido (texto corto)', '') || '';
    const capacidad = prompt('Capacidad (nÃºmero, vacÃ­o = ilimitado)', '') || '';
    const zonas = prompt('Zonas (separadas por coma, ej: San NicolÃ¡s, Puente Ã‘uble)', '') || '';
    const b = { bus_id: 'BUS_'+Math.random().toString(16).slice(2,8).toUpperCase(), nombre, recorrido, capacidad, zonas };
    cache.buses = [...(cache.buses||[]), b];
    await TS.core.upsertBusesLocal(cache.buses);
    await rebuildBusSelect();
    renderBuses();
    TS.toast('ğŸšŒ Bus creado');
  });

  document.getElementById('btnAddZona').addEventListener('click', async ()=>{
    const nombre = prompt('Nombre de zona (ej: San NicolÃ¡s Centro)');
    if(!nombre) return;
    const patrones = prompt('Patrones/keywords (separados por coma). Ej: centro, plaza, municipalidad', '') || '';
    const z = { zona_id: 'Z_'+Math.random().toString(16).slice(2,8).toUpperCase(), nombre, patrones };
    cache.zonas = [...(cache.zonas||[]), z];
    await TS.core.upsertZonasLocal(cache.zonas);
    renderZonas();
    TS.toast('ğŸ—ºï¸ Zona creada');
  });

  // Mode buttons + sync config
  async function refreshSyncNote(){
    const cfg = await TS.sync.getSyncConfig();
    document.getElementById('asUrl').value = cfg.appsScriptUrl || '';
    document.getElementById('apiKey').value = cfg.apiKey || '';
    document.getElementById('syncNote').textContent = cfg.enabled ? 'Sync habilitado. Acciones se guardan en Google Sheets.' : 'Sync deshabilitado. Acciones se guardan solo en este PC.';
  }
  await refreshSyncNote();

  document.getElementById('btnModeLocal').addEventListener('click', async ()=>{
    await TS.core.setMode('local');
    TS.toast('ğŸ’½ Modo Local');
    await loadCache(); await rebuildBusSelect(); renderBuses(); renderZonas(); renderWaitlist();
  });
  document.getElementById('btnModeSync').addEventListener('click', async ()=>{
    const cfg = await TS.sync.getSyncConfig();
    if(!cfg.appsScriptUrl || !cfg.apiKey){
      TS.toast('â›” Configura Apps Script URL + API Key primero');
      return;
    }
    cfg.enabled = true;
    await TS.sync.setSyncConfig(cfg);
    await TS.core.setMode('sync');
    TS.toast('â˜ï¸ Modo Sync');
    await refreshSyncNote();
    await loadCache(); await rebuildBusSelect(); renderBuses(); renderZonas(); renderWaitlist();
  });
  document.getElementById('btnSaveSync').addEventListener('click', async ()=>{
    const cfg = await TS.sync.getSyncConfig();
    cfg.appsScriptUrl = document.getElementById('asUrl').value.trim();
    cfg.apiKey = document.getElementById('apiKey').value.trim();
    await TS.sync.setSyncConfig(cfg);
    TS.toast('ğŸ’¾ Guardado');
    await refreshSyncNote();
  });
  document.getElementById('btnPing').addEventListener('click', async ()=>{
    try{
      const cfg = await TS.sync.getSyncConfig();
      cfg.enabled = true;
      await TS.sync.setSyncConfig(cfg);
      const res = await TS.sync.callApi('ping', { email: session.email });
      TS.toast('ğŸ“¡ OK: ' + (res.message||'conectado'));
      await refreshSyncNote();
    }catch(e){
      TS.toast('â›” ' + e.message);
    }
  });
});
</script>

  </main>

  <div class="footer">
    Â© NeoTech EduLab â€“ Transporte Escolar â€¢ Prohibida su copia y/o reproducciÃ³n
  </div>

  <script src="../assets/js/common.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/storage.js"></script>
  <script src="../config/config.js"></script>
  <script src="../assets/js/sync.js"></script>
  <script src="../assets/js/excel.js"></script>
  <script src="../assets/js/dashboard.js"></script>
  <!-- SheetJS (CDN). Si tu red bloquea CDNs, ejecuta el sitio con servidor local y/o reemplaza por copia local. -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
  
</body>
</html>
