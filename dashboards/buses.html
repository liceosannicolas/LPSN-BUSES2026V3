<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Transporte Escolar</title>
  <link rel="stylesheet" href="../assets/css/styles.css"/>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Transporte Escolar</div>
          <div class="subtitle">Dashboard por Bus</div>
        </div>
      </div>
      <div class="toolbar" aria-label="Controles">
        <button class="btn" data-action="speak" title="Narrador">ğŸ—£ï¸</button>
        <button class="btn" data-action="theme" title="Tema">ğŸŒ“</button>
        <button class="btn" data-action="fontPlus" title="Aumentar">A+</button>
        <button class="btn" data-action="fontMinus" title="Disminuir">Aâˆ’</button>
        <button class="btn" data-action="lang" title="Idioma">ğŸŒ</button>
        <a class="btn ghost" href="../index.html" title="Inicio">ğŸ </a>
      </div>
    </div>
    <div class="container">
      <div class="pillnav">
        <a href="../index.html">ğŸ  <span data-i18n="home">home</span></a>
<a href="../app/login.html">ğŸ” <span data-i18n="login">login</span></a>
<a href="../app/dashboard.html">ğŸ§¾ <span data-i18n="panel">panel</span></a>
<a href="../tools/importer.html">ğŸ§° <span data-i18n="importer">importer</span></a>
<a href="../dashboards/buses.html">ğŸšŒ <span data-i18n="buses">buses</span></a>
<a href="../dashboards/cursos.html">ğŸ“ <span data-i18n="cursos">cursos</span></a>
      </div>
    </div>
  </div>

  <main class="container">
    
<div class="grid">
  <section class="card" style="grid-column: span 12;">
    <div class="hd">
      <div><h2>ğŸšŒ Dashboard por Bus</h2><p>OcupaciÃ³n, recorrido y listado de estudiantes asignados (incluye correo). Fuente: Local o Sync segÃºn modo.</p></div>
      <div class="row">
        <button class="btn" id="btnRefresh">ğŸ”„ Refrescar</button>
        <button class="btn" id="btnExport">ğŸ“¤ Exportar Excel</button>
      </div>
    </div>
    <div class="bd">
      <div class="row">
        <div class="field">
          <label>Buscar</label>
          <input id="q" placeholder="bus, comuna, rut, correo..." style="min-width:360px"/>
        </div>
      </div>
      <div class="hr"></div>
      <div id="cards" class="grid"></div>
    </div>
  </section>
</div>

<script>
function esc(s){return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
function pct(a,b){ if(!b) return 0; return Math.round((a/b)*100); }

let cache=null;

async function load(){
  const mode = await TS.core.getMode();
  if(mode==='sync'){
    try{ cache = await TS.core.refreshFromSync(); }
    catch(e){ cache = await TS.core.loadAllLocal(); }
  }else cache = await TS.core.loadAllLocal();
}

function render(query=''){
  const cards = document.getElementById('cards');
  const q = query.trim().toLowerCase();
  const buses = cache.buses || [];
  const students = cache.students || [];
  const assigns = (cache.assignments||[]).filter(a=>a.estado==='ASIGNADO');

  const stByRut = new Map(students.map(s=>[s.rut,s]));
  const group = new Map();
  for(const a of assigns){
    if(!group.has(a.bus_id)) group.set(a.bus_id, []);
    group.get(a.bus_id).push(a);
  }

  const out = [];
  for(const b of buses){
    const list = group.get(b.bus_id) || [];
    const cap = parseInt(b.capacidad||'0',10) || 0;
    const used = list.length;
    const occ = cap ? pct(used, cap) : 0;
    const rows = list
      .map(a=>{
        const s = stByRut.get(a.rut) || {};
        const nom = [s.nombres,s.apellido_paterno,s.apellido_materno].filter(Boolean).join(' ');
        return { rut:a.rut, email:s.email||'', nombre:nom, comuna:s.comuna||'', nivel:s.nivel2026||'', recorrido:a.recorrido||b.recorrido||'', digitador:a.digitador||'' };
      })
      .sort((x,y)=>x.nombre.localeCompare(y.nombre));

    // filter
    const blob = (b.nombre+' '+b.recorrido+' '+rows.map(r=>`${r.rut} ${r.email} ${r.nombre} ${r.comuna} ${r.nivel}`).join(' ')).toLowerCase();
    if(q && !blob.includes(q)) continue;

    out.push(`
      <div class="card" style="grid-column: span 12;">
        <div class="hd">
          <div>
            <h2>ğŸšŒ ${esc(b.nombre||'Bus')}</h2>
            <p>Recorrido: ${esc(b.recorrido||'')} â€¢ Zonas: ${esc(b.zonas||'')}</p>
          </div>
          <div style="min-width:220px;">
            <div class="small">OcupaciÃ³n: <span class="kbd">${used}${cap?('/'+cap):''}</span> ${cap?('('+occ+'%)'):''}</div>
            <div class="progress"><div style="width:${cap?occ:0}%; background: var(--accent);"></div></div>
          </div>
        </div>
        <div class="bd" style="overflow:auto;">
          <table class="table">
            <thead><tr><th>RUT</th><th>Nombre</th><th>Correo</th><th>Comuna</th><th>Nivel 2026</th><th>Recorrido</th><th>Digitador</th></tr></thead>
            <tbody>
              ${rows.map(r=>`
                <tr>
                  <td><span class="kbd">${esc(r.rut)}</span></td>
                  <td>${esc(r.nombre)}</td>
                  <td>${esc(r.email)}</td>
                  <td>${esc(r.comuna)}</td>
                  <td>${esc(r.nivel)}</td>
                  <td>${esc(r.recorrido)}</td>
                  <td>${esc(r.digitador)}</td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `);
  }

  cards.innerHTML = out.join('') || '<div class="small">Sin datos. Importa nÃ³mina y asigna buses.</div>';
}

document.addEventListener('DOMContentLoaded', async ()=>{
  await load();
  render();
  document.getElementById('btnRefresh').addEventListener('click', async ()=>{ await load(); render(document.getElementById('q').value); TS.toast('ğŸ”„ OK'); });
  document.getElementById('q').addEventListener('input', (e)=>render(e.target.value));
  document.getElementById('btnExport').addEventListener('click', async ()=>{
    await load();
    const data = await TS.core.loadAllLocal();
    const wb = TS.excel.buildExportWorkbook(data);
    TS.excel.downloadWorkbook(wb, 'Dashboard_Buses.xlsx');
    TS.toast('ğŸ“¤ Exportado');
  });
});
</script>

  </main>

  <div class="footer">
    Â© NeoTech EduLab â€“ Transporte Escolar â€¢ Prohibida su copia y/o reproducciÃ³n
  </div>

  <script src="../assets/js/common.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/storage.js"></script>
  <script src="../config/config.js"></script>
  <script src="../assets/js/sync.js"></script>
  <script src="../assets/js/excel.js"></script>
  <script src="../assets/js/dashboard.js"></script>
  <!-- SheetJS (CDN). Si tu red bloquea CDNs, ejecuta el sitio con servidor local y/o reemplaza por copia local. -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
  
</body>
</html>
